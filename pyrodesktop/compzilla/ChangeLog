2007-05-08  Chris Toshok  <toshok@hungry.com>

	* compzilla/chrome/content/atoms.js: new file, split out the atoms
	stuff from compzillaWindowManager.js here, and dangle the object
	off the desktop element so different scripts can gain access to
	it.

	* compzilla/chrome/content/windowStack.js: reindent this - my
	modeline was ignored.
	
2007-05-08  Chris Toshok  <toshok@hungry.com>

	* compzilla/chrome/content/windowStack.js: document this a little
	bit, fix up some incorrect args to stackWindow, and only dangle
	off the windowStack element those methods which are public.
	Private ones are defined in the local file scope.

2007-05-08  Chris Toshok  <toshok@hungry.com>

	* compzilla/chrome/content/windowStack.js: first pass at the new
	windowstack code.  I've split it out from
	compzillaWindowManager.js but it can't be used until we get the
	mousethrough behavior fixed in mozilla.

2007-05-06  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindowEvents.cpp (Send): New, renamed
	from compzillaWindow::SendWindowEvent.

	* compzilla/src/compzillaControl.cpp: Call
	compzillaWindowEvents::Send instead of SendWindowEvent.
	(Filter): Pass deleted to PropertyChanged.
	(AddWindow): Send "windowCreate" and "windowDestroy" events.

2007-05-01  Chris Toshok  <toshok@ximian.com>

	* compzilla/chrome/content/scale.js: resize the test area from
	800x600 to 1024x768.  fix a typo that was causing all scales
	(except for the first window) to be 1.0, causing bizarre shrinkage
	problems.  add the fourth test div.

2007-05-01  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindowEvents.cpp: Add
	compzillaWindowEvent, a single impl of all the new window event
	ifaces.  Use the NS_FORWARD_NSIDOMEVENT macro to forward to an
	inner nsIDOMEvent.

	* compzilla/public/compzillaIWindowEvents.idl: Add
	compzillaIWindowEvent, compzillaIWindowConfigureEvent,
	compzillaIWindowPropertyEvent interfaces passed to
	compzillaIWindow event listeners.

	* compzilla/src/compzillaWindow.cpp (DestroyWindow): Emit
	"destroy" events.
	(MapWindow): Emit "show" events.
	(UnmapWindow): Emit "hide" events.
	(PropertyChanged): Emit "propertyChange" events.  Use SET_PROP
	macro to make this a bit less verbose.
	(WindowConfigured): Emit "moveResize" without coord data yet.
	(SendWindowEvent): Aggregates a compzillaWindowEvent with a newly
	created nsIDOMEvent and calls NotifyEventListeners with it.

	* compzilla/src/compzillaEventManager.cpp: Add HasEventListeners.

2007-04-25  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaControl.cpp (AddWindow): No need to cast
	to compzillaIWindow before passing to WindowCreated.

	* compzilla/src/compzillaEventManager.cpp: nsDOMJSUtils.h doesn't
	exist in mozilla1.8.

	* compzilla/src/compzillaWindow.cpp (WindowDamaged): Don't crash
	if a content node isn't a nsIDOMHTMLCanvasElement.

2007-04-24  Chris Toshok  <toshok@ximian.com>

	* compzilla/src/compzillaWindow.cpp: add the methods from
	compzillaControl here, and also extend this class to allow
	multiple content nodes.

	* compzilla/src/compzillaControl.h: move the atoms stuff out of
	here.

	* compzilla/src/compzillaControl.cpp: move many of the methods
	from here to compzillaWindow (everything that did a FindWin
	followed by an operation, basically, like UnmapWindow, MapWindow,
	WindowDestroyed, etc).

	* compzilla/public/compzillaIWindowManager.idl: add the
	compzillaIWindow parameter to WindowCreated, and remove the return
	type.

	* compzilla/public/compzillaIWindow.idl: add
	Get{String,Atom}Property methods.

	* compzilla/public/compzillaIControl.idl: we don't need
	Get{String,Atom}Property anymore.  they're in compzillaIWindow.idl

	* compzilla/components/compzillaWindowManager.js (WindowCreated):
	call compzillaIWindow.AddContentNodehere instead of returning the
	canvas element.

	* compzilla/Makefile.am (libcompzilla_la_SOURCES): add XAtoms.h

	* compzilla/src/XAtoms.h: new file.  check out that awesome union,
	yo.

2007-04-23  Chris Toshok  <toshok@ximian.com>

	* compzilla/Makefile.am (IDL_FILES): add compzillaIWindow.idl

	* compzilla/public/compzillaIWindow.idl: new interface.

2007-04-23  Chris Toshok  <toshok@ximian.com>

	* compzilla/components/compzillaWindowManager.js: rework the
	property change stuff to take the property.

	* compzilla/src/compzillaControl.cpp: put the window property
	stuff here for now.  Use a property bag to communicate arguments
	to the js.

2007-04-23  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaControl.cpp (AddEventListener,
	RemoveEventListener): Impl nsIDOMEventTarget, farming out to
	mWindowCreateEvMgr for "windowcreate" event.

	* compzilla/src/compzillaWindow.cpp (AddEventListener) 
	(RemoveEventListener): Ditto, but with "destroy", "moveresize",
	"show", "hide", and "propertychange" events.

	* compzilla/src/compzillaEventManager.h: New class to hold a list
	of nsIDOMEventListeners, and wrap all guts of nsIDOMEventTarget.

2007-04-21  Chris Toshok  <toshok@ximian.com>

	* compzilla/chrome/skin/compzilla.css: debug style changes (since
	we now have debugContent and debugLog).  Also, add the
	override_content class style.

	* compzilla/components/compzillaWindowManager.js: comment out some
	of the debug spew that was causing some operations to slow wayyy
	down.

	deal with the override_redirect window styling in a more css
	compliant way by setting override redirect content's CSS class to
	"override_content" instead of "content".  Move the opacity
	assignment to the stylesheet.

	Fix the weird windows showing up at startup (and when you opened
	certain applications like gedit or gnome-terminal.).  Turns out
	that we have to set the visibility on both the canvas and the wm
	frame to "hidden" for unmapped windows, or else the contents is
	displayed.  we were just hidding the wm frame.  firefox bug?

	factor out the creation of the debug window, and add a "Clear"
	button, which is horribly placed to be mostly obscured by the
	debug log.  Not sure why, but clicking on the part that *is*
	visible clears the log.

2007-04-20  Chris Toshok  <toshok@ximian.com>

	* compzilla/src/compzillaControl.cpp (SendConfigureNotify): spew
	out the configure info.
	(Filter): print out the border_width of the request here too.

	* compzilla/components/compzillaWindowManager.js:
	(WindowConfigured): remove the addition to width/height here.
	With it, gnome-terminal goes into an infinite loop requesting a
	new size, growing all the time.  heh.

2007-04-20  Chris Toshok  <toshok@ximian.com>

	* compzilla/components/compzillaWindowManager.js (WindowCreated):
	try to make sure the window is placed on screen, and deal with
	windows which are already mapped when we find out about them.
	(WindowConfigured): for the time being this is only ever called
	from the ConfigureRequest handler, so we don't need to worry about
	all the variety of cases metacity deals with in its horribly
	overloaded window resize code.  Also, at the moment we honor all
	requests, regardless of screen/window size.  So you can move
	windows completely off the screen, resize them larger than the
	screen, etc.  Since we're not changing the configure information,
	we follow the ICCCM and send a synthetic ConfigureNotify back to
	the client.
	(DocumentMouseMove): since so many resize handles result in both
	the window moving and resizing, make 1 call that does both (so we
	can make 1 XConfigureWindow call in the native code instead of 2.)
	(CreateWMChrome): clean this up a touch.  we don't need to both
	removeChild/appendChild to reparent a dom element, appendChild
	does both.
	(MoveElementTo): send a real ConfigureNotify event.
	(ResizeElementTo): same.
	(ResizeElementBy): call MoveAndResizeElementBy with 0,0 for dx,dy.
	(MoveElementBy): call MoveAndResizeElementBy with 0,0 for dw,dh.
	(MoveAndResizeElementBy): both move and resize the element, and
	generate 1 ConfigureNotify.

	* compzilla/public/compzillaIWindowManager.idl: add a boolean
	"mapped" arg to WindowCreated, so we can reflect the current state
	of a window previously mapped (really only useful when adding
	windows that were already created when we start up.)

	* compzilla/src/compzillaControl.cpp: globally reindent the SPEW
	lines.  Also, spew out the extension information as we query it.
	(SendConfigureNotify): new interface implementation.  Send a
	synthetic ConfigureNotify event.
	(ConfigureWindow): new interface implementation.  Send a real
	ConfigureNotify event.
	(ShowOutputWindow): make our region the same size as the display.
	(AddWindow): pass in a boolean telling the window manager if the
	window is already mapped.
	(Filter): we now do the WindowConfigured stuff in the
	ConfigureRequest case, and ignore ConfigureNotify events.

	* compzilla/public/compzillaIControl.idl: add two methods, one for
	sending a synthetic ConfigureNotify (SendSyntheticNotify) and one
	for actually configuring the window (ConfigureWindow).

	* compzilla/chrome/skin/compzilla.css: remove the explicit
	width/height from the .window class, and also make the debug spew
	smaller.

	* compzilla/src/compzillaWindow.cpp: add WITH_SPEW handling so we
	can turn off the spew.

	* compzilla/src/compzillaRenderingContext.cpp: add WITH_SPEW
	handling so we can turn off the spew.

	* compzilla/Makefile.am (libcompzilla_la_CPPFLAGS): add
	-DWITH_SPEW.

2007-04-19  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindow.cpp (EnsurePixmap): Don't call
	XDamageCreate until here, since it'll fail if we aren't mapped yet.

	* compzilla/src/compzillaControl.cpp (ErrorHandler): Print error
	info to the console.  This is mostly ripped from compiz.  Make the
	X extension event and error results static so we can access them
	from here.

2007-04-19  Chris Toshok  <toshok@ximian.com>

	* compzilla/chrome/content/start.js: resize the desktopWindow
	element to the size of the screen.

2007-04-18  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/nsKeycodes.h: New file, copied nsKeycodes and
	nsSunKeycodes DOM<->GDK keysym tables from
	mozilla/widget/src/gtk/nsGtkEventHandler.cpp.

	* compzilla/src/compzillaWindow.cpp (DOMKeyCodeToKeySym): New,
	converts a DOM keyCode to a GDK keysym.
	(SendKeyEvent): Use DOMKeyCodeToKeySym and XKeysymToKeycode to get
	the proper X keycode to forward to the native window.

	* compzilla/src/compzillaControl.cpp (Filter): We're the only ones
	who should process DAMAGE events, so remove them.

	Also change DEBUG -> SPEW, to avoid conflicting with the define
	used by nsDebug.h.
	
2007-04-18  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindow.cpp (HandleEvent): Initial
	FocusIn/Out, DOMMouseScroll, and KeyPress/Release support.

	* compzilla/src/compzillaControl.cpp (InitOutputWindow): Call
	XSetInputFocus for the Moz window.

	* compzilla/components/compzillaWindowManager.js: Set
	content.tabIndex=1 so the canvas elements are focusable.

2007-04-15  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaControl.cpp (InitWindowState): If we're
	the window manager, add all existing windows.  Init Shape
	extension.  Remove DEMO_HACK.
	(WindowDamaged): Move XDamageNotify handler to here.

2007-04-14  Chris Toshok  <toshok@ximian.com>

	* compzilla/src/compzillaRenderingContext.cpp (Redraw): fix the
	non-1.8 branch case for scaling the rectangle.

2007-04-13  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaRenderingContext.cpp (Redraw): Convert
	damaged rect to Twips, using the nsPresContext.

	* compzilla/src/compzillaWindow.cpp (compzillaWindow): Use manual
	redirection, and XDamageReportRawRectangles.

2007-04-12  Chris Toshok  <toshok@ximian.com>

	* compzilla/components/compzillaWindowManager.js
	(HookupChromeEvents): make the mousedown handler a capture phase
	event handler, so we can raise the window if we mouse down
	anywhere on it, and still have it end up going to the native
	window.

2007-04-12  Chris Toshok  <toshok@ximian.com>

	* compzilla/src/compzillaControl.cpp: use the new hotness.

	* compzilla/src/compzillaRenderingContext.h: new improved api.

	* compzilla/src/compzillaRenderingContext.cpp: rework this so we
	don't copy twice, we only ever blit anything in ::Render.

2007-04-12  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaRenderingContext.cpp: Drop non-thebes,
	non-render fallback code and remove mImageSurfaceData.
	(CopyImageDataFrom): For non-thebes, avoid XGetImage and call
	cairo_xlib_surface_create for the drawable to avoid copying data.

	* compzilla/src/compzillaControl.cpp (Filter): Pass window's
	visual to CopyImageDataFrom.

2007-04-11  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindow.cpp (SendMouseEvent): Make mouse
	event sending sorta work.  Use new GetSubwindowAtPoint to get
	destination subwindow, and fake enter/leave events when the
	subwindow changes.

2007-04-11  Chris Toshok  <toshok@ximian.com>

	* compzilla/chrome/skin/compzilla.css: add the overlay div's
	style.

	* compzilla/chrome/skin/desktop.html: add the overlay div here so
	people can add their widgets.

	* compzilla/src/compzillaRenderingContext.cpp (CopyImageDataFrom):
	fix a copy of glaring memory leaks.  we seem okay with memory now.

2007-04-10  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaControl.cpp (Filter): Call XSetInputFocus
	on MapRequest.

	* compzilla/src/compzillaWindow.cpp (HandleEvent): Send
	MotionNotify events if DOM eventtype is "mousemove".
	(SendMouseEvent): Set ButtonMotionMask correctly.

2007-04-10  Chris Toshok  <toshok@ximian.com>

	* compzilla/components/compzillaWindowManager.js: add an EWMH
	inspired layered window stack.

	* compzilla/chrome/skin/desktop.html: add an html tag, just cuz.

	* compzilla/chrome/skin/compzilla.css: add overflow: hidden to the
	html element, so we never see scrollbars on our desktop.

2007-04-10  Chris Toshok  <toshok@ximian.com>

	* compzilla/components/compzillaWindowManager.js: fairly big
	changes.  Clean up some errors that were screwing up
	sizing/scaling of override windows.  Also, add code to remove the
	wm chrome, and make it so you can call
	CreateWMChrome/DestroyWMChrome multiple times on the same window,
	which can happen when the _NET_WM_WINDOW_TYPE property is set on a
	window.  Add support for this property, so we now get a borderless
	panel (which isn't override_redirect, but is decorationless.)

	* compzilla/public/compzillaIControl.idl: add InternAtom and
	GetAtomProperty, and change signature for GetStringProperty.

	* compzilla/src/compzillaWindow.cpp: fix build on minefield.

	* compzilla/public/compzillaIWindowManager.idl: add x/y/w/h args
	to WindowCreated, and change PropertyChanged to take the atom
	instead of the string name.

	* compzilla/src/compzillaControl.cpp (InternAtom): new method,
	callable from JS.
	(GetStringProperty): we pass the atom, not the property name.
	(GetAtomProperty): new method, returns the atom value of a
	property.
	(InitManagerWindow): create the offscreen window and grab the
	window manager + compositor selections.  we aren't graceful about
	replacing an existing wm here.
	(AddWindow): add the x/y/width/height to the WindowCreated method
	call, so we can create the chrome of the right size.
	(PropertyChanged): pass the atom now, not the name.

	* compzilla/src/compzillaControl.h: change signature for
	PropertyChanged, and add manager window foo.

2007-04-10  Alex Graveley  <alex@beatniksoftware.com>

	* compzilla/src/compzillaWindow.cpp (SendMouseEvent): Adjust
	button+1, since DOM event buttons start at 0;
	(TranslateClientXYToWindow): New.  Adjusts a client x/y for the
	canvas frame's screen offset.  This seems to make button events
	work in the Metacity case, but focus stealing is preventing it
	in the standalone case.

	* compzilla/src/compzillaControl.cpp: Add commented out XEVIE
	stuff.  
	(Filter): Handle MapRequest and ConfigureRequest by just calling
	XMapRaised and XMoveResizeWindow respectively; eventually this
	should call the JS and allow for stopping/mutating the event.
	(InitWindowState): XSelectInput on the root win for
	SubstructureRedirectMask, and if errors occur (i.e. a WM is
	running), try again without it.

	* compzilla/src/compzillaControl.h: Keep an XError count, and add
	ClearError which returns the last count.  This is used to detect
	an existing WM.

	* compzilla/src/compzillaWindow.cpp: New.  Replaces
	CompositingWindow with an nsIDOMEventHandler subclass.

	* compzilla/src/compzillaModule.cpp: Use
	NS_GENERIC_FACTORY_CONSTRUCTOR(compzillaRenderingContext).

	* compzilla/src/compzillaRenderingContext.cpp: Drop
	CZ_NewRenderingContext.  Fix some whitespace.

